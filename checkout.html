<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siparişi Onayla - PAFA TEAMSPORT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="./assets/PAFA TEAMSPORT LOGO.png" type="image/x-icon">
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- Header Yükleme Alanı -->
    <div id="header-placeholder"></div>

    <main class="container mx-auto px-6 py-8 min-h-screen">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">Siparişi Onayla</h1>
        
        <div id="checkout-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Teslimat Bilgileri (Sol Taraf) -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-2xl p-6 md:p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Teslimat Bilgileri</h2>
                <form id="checkout-form" class="space-y-6">
                    <div>
                        <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">Ad Soyad</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Adınız Soyadınız">
                    </div>
                    
                    <div>
                        <label for="address" class="block text-sm font-semibold text-gray-700 mb-2">Adres</label>
                        <textarea id="address" rows="3" required class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Mahalle, Cadde, Sokak, No..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="city" class="block text-sm font-semibold text-gray-700 mb-2">Şehir</label>
                            <input type="text" id="city" required class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">Telefon</label>
                            <input type="tel" id="phone" required class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="5XX XXX XX XX">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Sipariş Özeti (Sağ Taraf) -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-2xl p-6 sticky top-28 border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Sipariş Özeti</h2>
                    
                    <div id="checkout-summary-items" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2">
                        <!-- Özet buraya yüklenecek -->
                    </div>

                    <div class="border-t pt-4">
                        <div class="flex justify-between text-2xl font-extrabold text-gray-900 mb-6">
                            <span>Toplam Tutar</span>
                            <span id="summary-total" class="text-emerald-600">0.00 TL</span>
                        </div>
                        
                        <button type="submit" form="checkout-form" id="confirm-order-btn" class="w-full text-center bg-emerald-500 text-white py-3 px-4 rounded-xl font-bold text-lg hover:bg-emerald-600 transition duration-150 shadow-md">
                            Ödemeyi Tamamla ve Siparişi Ver
                        </button>
                        <p class="text-xs text-gray-500 mt-4 text-center">
                            Not: Bu bir demo sitedir. Gerçek bir ödeme alınmayacaktır. Siparişiniz "Beklemede" olarak sisteme kaydedilecektir.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mesaj Modalı -->
        <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4"></h3>
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <button onclick="closeModal()" class="w-full bg-emerald-600 text-white py-2 rounded-md hover:bg-emerald-700 transition duration-200">Tamam</button>
            </div>
        </div>
    </main>

    <!-- Footer Yükleme Alanı -->
    <div id="footer-placeholder"></div>

    <script type="module">
        import { 
            loadHeaderAndFooter,
            initAuthAndNav, 
            currentUser,
            getCart,
            saveCart,
            getCartTotalPrice,
            createOrder,
            showModal
        } from './common.js';

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Auth durumunu kontrol et
            await initAuthAndNav();
            // 2. Header/Footer yükle
            await loadHeaderAndFooter(null); // Aktif link yok

            // 3. Auth ve Sepet Kontrolleri
            if (!currentUser) {
                showModal("Giriş Gerekli", "Siparişi onaylamak için lütfen giriş yapın.");
                setTimeout(() => window.location.href = './auth.html', 2000);
                return;
            }

            const cart = getCart();
            if (cart.length === 0) {
                showModal("Sepet Boş", "Sepetinizde ürün bulunmuyor. Ana sayfaya yönlendiriliyorsunuz.");
                setTimeout(() => window.location.href = './index.html', 2000);
                return;
            }

            // 4. Sayfayı yükle
            loadCheckoutSummary(cart);
            setupCheckoutForm(cart);
        });

        function loadCheckoutSummary(cart) {
            const summaryItemsEl = document.getElementById('checkout-summary-items');
            const totalPrice = getCartTotalPrice();
            
            summaryItemsEl.innerHTML = '';
            cart.forEach(item => {
                const price = (item.price || 0);
                const discount = (item.discount || 0);
                const discountedPrice = price * (1 - (discount / 100));
                
                summaryItemsEl.innerHTML += `
                    <div class="flex justify-between items-center text-sm text-gray-700">
                        <span class="font-semibold">${item.name} <span class="text-gray-500">x${item.quantity}</span></span>
                        <span>${(discountedPrice * item.quantity).toFixed(2)} TL</span>
                    </div>
                `;
            });

            document.getElementById('summary-total').textContent = `${totalPrice.toFixed(2)} TL`;

            // Kullanıcı bilgilerini forma doldur (eğer varsa)
            document.getElementById('name').value = currentUser.name || '';
        }

        function setupCheckoutForm(cart) {
            const form = document.getElementById('checkout-form');
            const submitBtn = document.getElementById('confirm-order-btn');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = "Sipariş oluşturuluyor...";
                submitBtn.classList.add('opacity-70', 'cursor-not-allowed');

                try {
                    const totalPrice = getCartTotalPrice();
                    
                    // Not: PayTR link mantığı burada devreye girebilir.
                    // Şimdilik sadece siparişi kaydediyoruz.
                    
                    await createOrder(cart, totalPrice);

                    // Sipariş başarılı
                    saveCart([]); // Sepeti temizle
                    showModal("Sipariş Başarılı!", "Siparişiniz başarıyla alındı. Siparişlerim sayfanıza yönlendiriliyorsunuz.");
                    setTimeout(() => window.location.href = './my-orders.html', 2000);

                } catch (error) {
                    console.error("Sipariş verme hatası:", error);
                    showModal("Hata", `Sipariş oluşturulurken bir hata oluştu: ${error.message}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Ödemeyi Tamamla ve Siparişi Ver";
                    submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            });
        }
    </script>
</body>
</html>
